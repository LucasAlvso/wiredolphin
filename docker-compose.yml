version: "3.8"

services:
  wiredolphin:
    build: .
    container_name: wiredolphin
    restart: unless-stopped

    # Capabilities needed to create tun interface, iptables, and open raw sockets
    cap_add:
      - NET_ADMIN
      - NET_RAW

    # Access to /dev/net/tun from host
    devices:
      - "/dev/net/tun:/dev/net/tun"

    # Enable forwarding inside container for NAT (if the tunnel sets it)
    sysctls:
      net.ipv4.ip_forward: "1"

    # Persist CSV logs and provide tunnel binary/source
    working_dir: /logs
    volumes:
      - ./logs:/logs

    # Environment configuration
    environment:
      # Analyzer interface (created by the tunnel)
      - IFACE=tun0
      # Physical/underlay interface (inside the container) used by the tunnel server
      - TUN_UNDERLAY_IF=eth0
      # Whether to start the tunnel process; set to false if you already run tunnel externally
      - TUN_START=true
      # Seconds to wait for IFACE to appear
      - TUN_WAIT_TIMEOUT=20
