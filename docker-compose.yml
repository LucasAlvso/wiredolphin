services:
  wiredolphin:
    image: wiredolphin:latest
    build: .
    container_name: wiredolphin
    restart: unless-stopped
    network_mode: host

    # Capabilities needed to create tun interface, iptables, and open raw sockets
    cap_add:
      - NET_ADMIN
      - NET_RAW

    # Access to /dev/net/tun from host
    devices:
      - "/dev/net/tun:/dev/net/tun"

    # Note: when using host networking, sysctls cannot be applied via compose.
    # IP forwarding will be attempted in entrypoint and ignored if not permitted.

    # Persist CSV logs and provide tunnel binary/source
    working_dir: /logs
    volumes:
      - ./logs:/logs

    environment:
      - IFACE=tun0
      - TUN_UNDERLAY_IF=eth0
      - TUN_START=true
      - TUN_WAIT_TIMEOUT=20
      - TUN_ADDR_CIDR=172.31.66.1/24
      - TUN_ENABLE_NAT=true
      - TUN_GEN_TRAFFIC=true

  client1:
    image: wiredolphin:latest
    depends_on:
      - wiredolphin
    container_name: wiredolphin-client1
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - "/dev/net/tun:/dev/net/tun"
    volumes:
      - ./traffic_tunnel:/client-config:ro
  # Use default bridge networking to keep client TUN interfaces isolated
    environment:
      - IFACE=tun0
      - CLIENT_UNDERLAY_IF=eth0
      - CLIENT_SCRIPT=/client-config/client1.sh
      - GEN_TRAFFIC=${TUN_GEN_TRAFFIC:-true}
      - GEN_DHCP=true
      - PING_TARGET=1.1.1.1
      - PING_COUNT=3
      - HTTP_URL=http://172.31.66.1/
      - DNS_NAME=example.com
      - DNS_SERVER=1.1.1.1
      - NTP_SERVER=pool.ntp.org
      - TUN_WAIT_TIMEOUT=20
    entrypoint: ["/entrypoint-client.sh"]

  client2:
    image: wiredolphin:latest
    depends_on:
      - wiredolphin
    container_name: wiredolphin-client2
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - "/dev/net/tun:/dev/net/tun"
    volumes:
      - ./traffic_tunnel:/client-config:ro
  # Use default bridge networking to keep client TUN interfaces isolated
    environment:
      - IFACE=tun0
      - CLIENT_UNDERLAY_IF=eth0
      - CLIENT_SCRIPT=/client-config/client2.sh
      - GEN_TRAFFIC=${TUN_GEN_TRAFFIC:-true}
      - GEN_DHCP=true
      - PING_TARGET=8.8.8.8
      - PING_COUNT=3
      - HTTP_URL=http://172.31.66.1/
      - DNS_NAME=cloudflare.com
      - DNS_SERVER=8.8.8.8
      - NTP_SERVER=time.google.com
      - TUN_WAIT_TIMEOUT=20
    entrypoint: ["/entrypoint-client.sh"]
